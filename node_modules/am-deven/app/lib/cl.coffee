#config
console.log new Date(), "process start"
interval = 5 * 60000# / 60  # テスト時は５秒に１回
#vars
execSync = require("child_process").execSync
exec = require("child_process").exec
proc = null
#commands
json = require("fs").readFileSync("./package.json", {encoding: "utf-8"})
commands = JSON.parse(json).scripts
start = ->
  preproc = execSync(commands.compileAll, {encoding:"utf-8"})
  proc = exec(commands.serverStart)
check = (first = false) ->
  try
    reply = execSync("git pull origin", {encoding:"utf-8"})
  catch error
    console.log error
    return
  console.log new Date(), reply
  return start() if first
  unless reply.match("Already up-to-date")# or false #強制稼働
    console.log new Date(), "process exit"
    proc.kill()
    start()
cl = -> setInterval(check, interval)
#exe
cl()
check(true)
