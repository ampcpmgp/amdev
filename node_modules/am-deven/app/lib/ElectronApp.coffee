fs = require("fs")
ipc = require("ipc")
np = new (require("am-node-parts"))
$ = require("jquery")

module.exports = class ElectronApp
  _inspector: 1
  constructor: ->
  start: ->
    @init()
    @live_reload()
  ### 信頼しているメソッドなるべくフロー順 ###
  init: ->
    if @_inspector then @auto_inspector()
    ipc.on("browser send msg",(msg) -> console.log("%cfrom Browser, %c#{msg}", "color: gray", "color: blue"))
  auto_inspector: ->
    $(document).on "mousedown", (e) ->
      if e.button is 2
        obj =
          x: e.clientX
          y: e.clientY
        ipc.send('inspect element', obj, "mainWindow")
  live_reload: ->
    #Watcher
    _watcher_callback = (loc, eventname, filename) =>
      return if filename.match(/\.(map|coffee)/)
      if @_start_flag then return else @_start_flag = true
      location.reload()
    fs.watch("./app/index.html", _watcher_callback)
    np.watch_dir_tree("./", [/\/(app|test)\/lib\//, /\/am-node-parts\/lib\//], _watcher_callback)
    # TODO: CSS reload, web and electron app
